<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client</title>
  <link rel="stylesheet" href="presIndex.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

</head>

<body>

  <div id="fullScreenPresentation" class="w3-hide">
    <div id="themeFullscreen">
      <h1 id="presTitleFullscreen" class="w3-center"></h1>
      <div id="inputImgFullscreen" class="w3-center"></div>
      <div id="presParagraphFullscreen" class="w3-center"></div>
    </div>
    <div id="toolbar" class="w3-bar w3-center">
      <a class="w3-bar-item" href="#">
        <div id="stopFs" class="w3-button">Stop fullscreen</div>
      </a>
      <a class="w3-bar-item" href="#">
        <div id="previous" class="w3-button">Previous</div>
      </a>
      <a class="w3-bar-item" href="#">
        <div id="next" class="w3-button">Next</div>
      </a>
    </div>
  </div>

  <div id="viewNormal" class="w3-row w3-show">
    <div class="w3-container w3-border w3-white container">
      <div class="w3-col l2 s2">
        <div class="w3-container w3-white">
          <div class="gui">
            <p id="presName">Presentation</p>
            <a href="#" id="goBackBtn" class="w3-bar-item w3-button w3-right">
              <i class="material-icons">home</i>
              <br><label>Home</label>
            </a>
          </div>
          <div class="scroller">
          <p>Slides</p>
          <ul id="allSlides" class="w3-ul">
            <li id="Slides" class="w3-hover-grey w3-button" value="1">Slide 1 </li>
          </ul>
        </div>
          <button id="presFullScreenBtn" class="w3-right w3-button w3-display-bottomleft"><i id="viewBtn"
              class="material-icons w3-xxl">tv</i></button>

        </div>
      </div>
      <div class="w3-col l10 s10">
        <div id="edit" class="w3-container w3-center edit">
          <div id="theme"> </div>
          <h1 id="presTitle" class="w3-center"></h1>
          <div id="inputImg" class="w3-center"></div>
          <div id="presParagraph" class="w3-center">
          </div>
        </div>

      </div>
    </div>
  </div>

</body>

<script>


  // globale variabler

  let isFullScreenOn = false;
  let listItemIndex = 0;
  let currentSlide = 1;
  let presentation = "";

  //

  // Går tilbake til userindex

  const slideListener = document.getElementById("allSlides");;
  goBackBtn = document.getElementById("goBackBtn");
  goBackBtn.addEventListener("click", function (evt) {
    location.href = "/userIndex.html";
  });

  //

  // laster inn PresentationProject hvis dette finnes

  getPresentation();
  async function getPresentation() {
    let presId = sessionStorage.getItem("CurrentlyViewing");
    //presId = JSON.parse(presId);

    if (presId === null) {
      //location.href = "/userIndex.html";
      presId = prompt("Presentation ID:");
      sessionStorage.setItem("CurrentlyViewing", presId);
      if(!presId || presId.length === 0){
        location.href = "/userIndex.html";
      }
    }

    const body = { presentationId: presId };
    const url = `/view/presentation/${presId}`;

    const results = await callServerAPI(body, url);

    const pres = results.data[0];
    presentation = pres;
    document.title = "Viewing: " + presentation.name;
    const slides = pres.slides;

    if (slides) {

      let bildeUrl = "pictures/Theme_Light.png";

      if (pres.theme === "Dark") {
        //const themeStyle = document.getElementById("theme");
        //themeStyle.innerHTML = `<img id="themeImage" src="pictures/Theme_Dark.png">`;
        bildeUrl = "pictures/Theme_Dark.png";
      }

      let editFullscreen = document.getElementById("fullScreenPresentation");
      editFullscreen.style.background = "url(" + bildeUrl + ")";
      editFullscreen.style.width = "100%";
      editFullscreen.style.height = "100vh";

      let edit = document.getElementById("edit");
      edit.style.background = "url(" + bildeUrl + ")";
      edit.style.width = "100%";
      edit.style.height = "100vh";

      //sessionStorage.setItem("CurrentlyViewing", JSON.stringify(pres));

      gotoSlide(currentSlide);

      refreshPresentation();

    } else {
      //location.href = "/userIndex.html";
    }
  }

  //

  // refresh presentation, henter presentasjonen fra sessionstorage og viser innhold 

  function refreshPresentation() {

    /*let presentation = sessionStorage.getItem("CurrentlyViewing");
    presentation = JSON.parse(presentation);*/
    slides = presentation.slides;

    const presName = document.getElementById("presName");

    presName.innerHTML = presentation.name;

    const allSlides = document.getElementById("allSlides");

    allSlides.innerHTML = "";

    const totalSlides = Object.entries(slides).length;

    if (presentation.slides.Slide1 !== undefined) {
      allSlides.innerHTML += `<li id="Slides" class="w3-hover-grey w3-button" value="1">Slide 1 </li>`
    }

    for (let i = 2; i <= totalSlides; i++) {
      allSlides.innerHTML += `<br><li id="Slides" class="w3-hover-grey w3-button" value="${i}">Slide ${i}</li>`;
    }

  }

  const switchKeys = document.getElementById("fullScreenPresentation");

  document.body.addEventListener("keydown", function (evt) {
    const key = evt.keyCode;

    if (isFullScreenOn) {

      if (key === 27) {
        fullscreenFunction();
      }

      if (key === 39) {
        currentSlide++;
        gotoSlide(currentSlide);
      }
      if (key === 37) {
        currentSlide--;
        gotoSlide(currentSlide);
      }

    }
  });

  //

  // Går til sliden brukeren trykker på

  slideListener.addEventListener("click", function (evt) {

    if (evt.target.id === "Slides") {
      gotoSlide(evt.target.value);
    }

  });


  const previous = document.getElementById("previous");
  const next = document.getElementById("next");

  previous.addEventListener("click", function (evt) {
    currentSlide--;
    gotoSlide(currentSlide);
  });

  next.addEventListener("click", function (evt) {
    currentSlide++;
    gotoSlide(currentSlide);
  });

  //


  // goto slide, oppdaterer slide innhold

  function gotoSlide(slideNr) {
    listItemIndex = 0;
    /*let presentation = sessionStorage.getItem("CurrentlyViewing");
    presentation = JSON.parse(presentation);*/

    if (slideNr === undefined || slideNr < 1) {
      if (presentation.slides.Slide1 !== undefined) {
        slideNr = 1;
      } else {
        return;
      }
    }

    currentSlide = slideNr;

    let titleDom = document.getElementById("presTitle");
    let paragraphDom = document.getElementById("presParagraph");
    let imgDom = document.getElementById("inputImg");

    let titleDomFullscreen = document.getElementById("presTitleFullscreen");
    let paragraphDomFullscreen = document.getElementById("presParagraphFullscreen");
    let imgDomFullscreen = document.getElementById("inputImgFullscreen");

    let fontType = presentation.font;

    switch (fontType) {
      case 1:
        fontType = "sansserif";
        break;
      case 2:
        fontType = "serif";
        break;
      case 3:
        fontType = "monospace";
        break;
      default:
        fontType = "sansserif";
        break;
    }

    const presFullScreenBtn = document.getElementById("presFullScreenBtn");


    paragraphDom.innerHTML = "";
    titleDom.innerHTML = "";
    imgDom.innerHTML = "";

    paragraphDomFullscreen.innerHTML = "";
    titleDomFullscreen.innerHTML = "";
    imgDomFullscreen.innerHTML = "";

    paragraphDom.classList = `w3-center ${fontType}`
    titleDom.classList = `w3-center ${fontType}`

    paragraphDomFullscreen.classList = `w3-center ${fontType}`
    titleDomFullscreen.classList = `w3-center ${fontType}`

    let slideEditMode = presentation.slides["Slide" + currentSlide];
    if (!slideEditMode) {

      currentSlide--;
      slideEditMode = presentation.slides["Slide" + currentSlide];

      if (!slideEditMode) {
        return;
      }
    }


    titleDomFullscreen.innerHTML = slideEditMode.title;
    titleDom.innerHTML = slideEditMode.title;

    if (slideEditMode.image !== undefined) {


      if (slideEditMode.image !== "") {

        imgDom.innerHTML = `<img class="presImage" src="${slideEditMode.image}">`;
        paragraphDom.innerHTML = slideEditMode.imageText;
        imgDomFullscreen.innerHTML = `<img class="presImage" src="${slideEditMode.image}">`;
        paragraphDomFullscreen.innerHTML = slideEditMode.imageText;

      }

    }

    if (slideEditMode.list) {

      let listArr = slideEditMode.list;

      for (let i = 0; i < listArr.length; i++) {
        paragraphDom.innerHTML += `<p id='itemIndexNum${listItemIndex}' class='listItem ${fontType}'>&#8226; ${listArr[i]}</p>`;
        paragraphDomFullscreen.innerHTML += `<p id='itemIndexNum${listItemIndex}' class='listItem ${fontType}'>&#8226; ${listArr[i]}</p>`;
        listItemIndex++;
      }

    }
  }

  //

  // fullscreen presentation btn eventlisteners

  const presFullScreenBtn = document.getElementById("presFullScreenBtn");

  presFullScreenBtn.addEventListener('click', function (evt) {
    fullscreenFunction();
  });

  const stopFs = document.getElementById("stopFs");

  stopFs.addEventListener('click', function (evt) {
    fullscreenFunction();
  });

  //

  // fullscren function
  function fullscreenFunction() {

    const viewNormal = document.getElementById("viewNormal");

    const fullScreenPresentation = document.getElementById("fullScreenPresentation");

    // kjør fullscreen 

    if (isFullScreenOn === false) {
      fullScreenPresentation.classList.remove("w3-hide");
      fullScreenPresentation.classList.add("w3-show");

      viewNormal.classList.remove("w3-show");
      viewNormal.classList.add("w3-hide");

      isFullScreenOn = true;

      return;
    }

    if (isFullScreenOn === true) {
      fullScreenPresentation.classList.remove("w3-show");
      fullScreenPresentation.classList.add("w3-hide");

      viewNormal.classList.remove("w3-hide");
      viewNormal.classList.add("w3-show");

      isFullScreenOn = false;
      return;
    }
  }

  //

  // fetch server api function

  async function callServerAPI(body, url) {

    if (body === "" || url === "") {
      return;
    }

    const config = {
      method: "POST",
      headers: {
        "content-type": "application/json"
      },
      body: JSON.stringify(body)
    }

    const response = await fetch(url, config);
    const data = await response.json();
    console.log(response.status);
    return { "response": response, "data": data };
  };

//


</script>