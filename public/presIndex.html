<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client</title>
  <link rel="stylesheet" href="presIndex.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

</head>

<body>

  <div id="fullScreenPresentation" class="w3-hide">
    <div id="themeFullscreen">
      <h1 id="presTitleFullscreen" class="w3-center"></h1>
      <div id="inputImgFullscreen" class="w3-center"></div>
      <div id="presParagraphFullscreen" class="w3-center"></div>
    </div>
    <div id="toolbar" class="w3-bar w3-center">
      <a class="w3-bar-item" href="#">
        <div id="stopFs" class="w3-button">Stop fullscreen</div>
      </a>
      <a class="w3-bar-item" href="#">
        <div id="previous" class="w3-button">Previous</div>
      </a>
      <a class="w3-bar-item" href="#">
        <div id="next" class="w3-button">Next</div>
      </a>
    </div>
  </div>

  <div id="viewNormal" class="w3-row w3-show">
    <div class="w3-container w3-border w3-white container">
      <div class="w3-col l2 s2">
        <div class="w3-container w3-white">
          <div class="gui">
            <p id="presName">Presentation</p>
            <a href="#" id="goBackBtn" class="w3-bar-item w3-button w3-right">
              <i class="material-icons">home</i>
              <br><label>Home</label>
            </a>
          </div>
          <p>Slides</p>
          <ul id="allSlides" class="w3-ul">
            <li id="Slides" class="w3-hover-grey w3-button" value="1">Slide 1 </li>
          </ul>
          <button id="presFullScreenBtn" class="w3-right w3-button w3-display-bottomleft"><i id="viewBtn"
              class="material-icons w3-xxl">tv</i></button>

        </div>
      </div>
      <div class="w3-col l10 s10">
        <div id="edit" class="w3-container w3-center edit">
          <div id="theme"> </div>
          <h1 id="presTitle" class="w3-center"></h1>
          <div id="inputImg" class="w3-center"></div>
          <div id="presParagraph" class="w3-center">
          </div>
        </div>

      </div>
    </div>
  </div>

</body>

<script>

  let isFullScreenOn = false;
  let listItemIndex = 0;


  const slideListener = document.getElementById("allSlides");;
  goBackBtn = document.getElementById("goBackBtn");
  goBackBtn.addEventListener("click", function (evt) {
    location.href = "/userIndex.html";
  });

  getPresentation(); //laster inn PresentationProject hvis dette finnes
  async function getPresentation() {
    let presentation = sessionStorage.getItem("CurrentlyViewing");
    presentation = JSON.parse(presentation);

    if (presentation === null) {
      location.href = "/userIndex.html";
      return;
    }

    const token = sessionStorage.getItem("token");
    const username = sessionStorage.getItem("user");
    const body = { authToken: token, user: username, presentationId: presentation.id };
    const url = `/user/presentation/${presentation.id}`;

    const results = await callServerAPI(body, url);

    const pres = results.data[0];
    const slides = pres.slides;

    if (slides) {

      let bildeUrl = "pictures/Theme_Light.png";

      if (pres.theme === "Dark") {
        //const themeStyle = document.getElementById("theme");
        //themeStyle.innerHTML = `<img id="themeImage" src="pictures/Theme_Dark.png">`;
        bildeUrl = "pictures/Theme_Dark.png";
      }

      let editFullscreen = document.getElementById("fullScreenPresentation");
      editFullscreen.style.background = "url(" + bildeUrl + ")";
      editFullscreen.style.width = "100%";
      editFullscreen.style.height = "550px";

      let edit = document.getElementById("edit");
      edit.style.background = "url(" + bildeUrl + ")";
      edit.style.width = "100%";
      edit.style.height = "550px";

      localStorage.setItem("PresentationProject", JSON.stringify(pres));

      gotoSlide(currentSlide);

      refreshPresentation();

    } else {
      location.href = "/userIndex.html";
    }
  }

  function refreshPresentation() {

    let presentation = localStorage.getItem("PresentationProject");
    presentation = JSON.parse(presentation)
    slides = presentation.slides;

    const presName = document.getElementById("presName");

    presName.innerHTML = presentation.name;

    const allSlides = document.getElementById("allSlides");

    allSlides.innerHTML = "";

    const totalSlides = Object.entries(slides).length;

    if (presentation.slides.Slide1 !== undefined) {
      allSlides.innerHTML += `<li id="Slides" class="w3-hover-grey w3-button" value="1">Slide 1 </li>`
    }

    for (let i = 2; i <= totalSlides; i++) {
      allSlides.innerHTML += `<br><li id="Slides" class="w3-hover-grey w3-button" value="${i}">Slide ${i}</li>`;
    }

    //slideListener = document.getElementById("allSlides");

  }

  const switchKeys = document.getElementById("fullScreenPresentation");

  document.body.addEventListener("keydown", function (evt) {
    const key = evt.keyCode;
    console.log(key)

    if (isFullScreenOn) {

      if (key === 27) {
        fullScreenPresentation.classList.remove("w3-show");
        fullScreenPresentation.classList.add("w3-hide");

        viewNormal.classList.remove("w3-hide");
        viewNormal.classList.add("w3-show");
        isFullScreenOn = false;
      }

      if (key === 39) {
        currentSlide++;
        gotoSlide(currentSlide);
      }
      if (key === 37) {
        currentSlide--;
        gotoSlide(currentSlide);
      }

    }
  });


  slideListener.addEventListener("click", function (evt) {

    if (evt.target.id === "Slides") {
      gotoSlide(evt.target.value);
    }

  });


  let currentSlide = 1;

  function gotoSlide(slideNr) {
    listItemIndex = 0;
    let presentation = localStorage.getItem("PresentationProject");
    presentation = JSON.parse(presentation);

    if (slideNr === undefined || slideNr < 1) {
      if (presentation.slides.Slide1 !== undefined) {
        slideNr = 1;
      } else {
        return;
      }
    }

    currentSlide = slideNr;

    let titleDom = document.getElementById("presTitle");
    let paragraphDom = document.getElementById("presParagraph");
    let imgDom = document.getElementById("inputImg");

    let titleDomFullscreen = document.getElementById("presTitleFullscreen");
    let paragraphDomFullscreen = document.getElementById("presParagraphFullscreen");
    let imgDomFullscreen = document.getElementById("inputImgFullscreen");

    const presFullScreenBtn = document.getElementById("presFullScreenBtn");

    presFullScreenBtn.addEventListener('click', function (evt) {

      const viewNormal = document.getElementById("viewNormal");

      const fullScreenPresentation = document.getElementById("fullScreenPresentation");

      // kjÃ¸r fullscreen 

      if (isFullScreenOn === false) {
        fullScreenPresentation.classList.remove("w3-hide");
        fullScreenPresentation.classList.add("w3-show");

        viewNormal.classList.remove("w3-show");
        viewNormal.classList.add("w3-hide");

        isFullScreenOn = true;

        return;
      }

      if (isFullScreenOn === true) {
        fullScreenPresentation.classList.remove("w3-show");
        fullScreenPresentation.classList.add("w3-hide");

        viewNormal.classList.remove("w3-hide");
        viewNormal.classList.add("w3-show");

        isFullScreenOn = false;
        return;
      }

    });


    paragraphDom.innerHTML = "";
    titleDom.innerHTML = "";
    imgDom.innerHTML = "";

    paragraphDomFullscreen.innerHTML = "";
    titleDomFullscreen.innerHTML = "";
    imgDomFullscreen.innerHTML = "";

    let slideEditMode = presentation.slides["Slide" + currentSlide];
    if (!slideEditMode) {

      currentSlide--;
      slideEditMode = presentation.slides["Slide" + currentSlide];

      if (!slideEditMode) {
        return;
      }
    }


    titleDomFullscreen.innerHTML = slideEditMode.title;
    titleDom.innerHTML = slideEditMode.title;

    if (slideEditMode.image !== undefined) {


      if (slideEditMode.image !== "") {

        imgDom.innerHTML = `<img src="${slideEditMode.image}">`;
        paragraphDom.innerHTML = slideEditMode.imageText;
        imgDomFullscreen.innerHTML = `<img src="${slideEditMode.image}">`;
        paragraphDomFullscreen.innerHTML = slideEditMode.imageText;

      }

    }

    if (slideEditMode.list) {

      let listArr = slideEditMode.list;

      for (let i = 0; i < listArr.length; i++) {
        //paragraphDom.innerHTML += `<p id='listItem${listItemIndex}' class='listItem''>&#8226; ${listArr[i]}</p>`;
        paragraphDom.innerHTML += `<p id='itemIndexNum${listItemIndex}' class='listItem'>&#8226; ${listArr[i]}</p>`;
        paragraphDomFullscreen.innerHTML += `<p id='itemIndexNum${listItemIndex}' class='listItem'>&#8226; ${listArr[i]}</p>`;
        listItemIndex++;
      }

    }
  }


  // fetch server api function

  async function callServerAPI(body, url) {

    if (body === "" || url === "" || !body.authToken) {
      return;
    }

    const config = {
      method: "POST",
      headers: {
        "content-type": "application/json"
      },
      body: JSON.stringify(body)
    }

    const response = await fetch(url, config);
    const data = await response.json();
    console.log(response.status);
    return { "response": response, "data": data };
  };

//


</script>