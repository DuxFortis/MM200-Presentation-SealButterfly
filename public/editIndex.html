<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client</title>
  <link rel="stylesheet" href="editIndex.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

</head>

<body>

  <img id="logo" src="./pictures/logo.png">


  <div class="w3-dropdown-click w3-right">
    <button id="accountText" onclick="myAccount()" class="w3-button w3-white">Account</button>
    <div id="Acc" class="w3-dropdown-content w3-bar-block w3-border">
      <a href="#" id="logOut" class="w3-bar-item w3-button">Log out</a>
      <a href="#" id="deleteAcc" class="w3-bar-item w3-button">Delete account</a>
    </div>
  </div>



  <div class="w3-row">
    <div class="w3-container w3-border w3-white container">
      <div class="w3-col l2 s2">
        <div class="w3-container w3-white">
          <p>Your slides</p>
          <div class="scroller">
            <ul id="allSlides" class="w3-ul">
              <li id="Slides" class="w3-hover-grey w3-button tablinkSlide slideTab" value="1">Slide 1 </li>
            </ul>
          </div>
          <br>
          <div id="newSlideBtn" class="w3-hover-grey w3-button">Create slide</div>
          <br>
          <div id="deleteSlideBtn" class="w3-hover-grey w3-button">Delete slide </div>
        </div>
      </div>
      <div class="w3-col l8 s8">
        <div class="w3-container w3-border w3-white">
          <div class="w3-bar w3-light-grey">
            <a href="#" class="w3-bar-item w3-button" onClick="updatePresentation()">
              <i id="saveBtn" class="material-icons">save</i>
              <br><label>Save</label>
            </a>
            <div class="w3-dropdown-hover">
              <button class="w3-button">
                <i class="material-icons">T</i>
              </button>
              <br><label>Font</label>
              <div class="w3-dropdown-content w3-bar-block w3-card-4">
                <a id="arialBtn" href="#" class="w3-bar-item w3-button">Arial</a>
                <a id="timesBtn" href="#" class="w3-bar-item w3-button">Times New Roman</a>
                <a id="lucidaBtn" href="#" class="w3-bar-item w3-button">Lucida Console</a>
              </div>
            </div>
            <div id="presentationVisability">
              <a href="#" class="w3-bar-item w3-button" onClick="changeVisability('public', true)">
                <div id="private" name="visability" value="private">
                  <i class="fa fa-lock"></i></div>
                <label>Private</label>
              </a>
            </div>
            <a id="renamePres" href="#" class="w3-bar-item">
              <input id="renamePresInp" type="text" placeholder="Rename presentation">
            </a>
            <a href="#" class="w3-bar-item">
              <div id="thisPres"></div>
            </a>
            <a href="#" id="goBackBtn" class="w3-bar-item w3-button w3-right">
              <i class="material-icons">home</i>
              <br><label>Home</label>
            </a>
          </div>
        </div>

        <div id="edit" class="w3-container w3-center edit">
          <div id="theme"> </div>
          <h1 id="presTitle" class="w3-center"></h1>
          <div id="presParagraph" class="w3-center">
          </div>
        </div>
      </div>
      <div class="w3-col l2 s2">
        <div class="w3-container w3-white">
          <p>Slide Templates</p>
          <ul class="w3-ul">
            <li id="templateTitleBtn" class="w3-hover-grey w3-button">Template Title</li>
            <li id="templatePictureBtn" class="w3-hover-grey w3-button">Template Picture</li>
            <li id="templateListBtn" class="w3-hover-grey w3-button">Template List</li>
          </ul>
          <button id="addListBtn" class="w3-hide" onclick="addListItem()">Add list item</button>
        </div>
      </div>
    </div>
  </div>

</body>

<script>

  const templateTitleBtn = document.getElementById("templateTitleBtn");
  const templatePictureBtn = document.getElementById("templatePictureBtn");
  const templateListBtn = document.getElementById("templateListBtn");
  const addListBtn = document.getElementById("addListBtn");

  let imgdata = "";
  let templateCheck = "";

arialBtn = document.getElementById(`arialBtn`);
timesBtn = document.getElementById(`timesBtn`);
lucidaBtn = document.getElementById(`lucidaBtn`);

arialBtn.addEventListener(`click`, () =>{
  presParagraph.classList.add(`sansserif`);
  presTitle.classList.add(`sansserif`);
  presParagraph.classList.remove(`monospace`);
  presTitle.classList.remove(`monospace`);
  presParagraph.classList.remove(`serif`);
  presTitle.classList.remove(`serif`);
})

timesBtn.addEventListener(`click`, () =>{
  presParagraph.classList.add(`serif`);
  presTitle.classList.add(`serif`);
  presParagraph.classList.remove(`monospace`);
  presTitle.classList.remove(`monospace`);
  presParagraph.classList.remove(`sansserif`);
  presTitle.classList.remove(`sansserif`);
})

lucidaBtn.addEventListener(`click`, () =>{
  presParagraph.classList.add(`monospace`);
  presTitle.classList.add(`monospace`);
  presParagraph.classList.remove(`sansserif`);
  presTitle.classList.remove(`sansserif`);
  presParagraph.classList.remove(`serif`);
  presTitle.classList.remove(`serif`);
})

  

  templateTitleBtn.addEventListener('click', function (evt) {

    templateCheck += "Title"
    console.log(templateCheck);

    insertTemplateSlide();
    templateCheck = "";


  })
  templatePictureBtn.addEventListener('click', function (evt) {

    templateCheck += "Picture"

    insertTemplateSlide();
    templateCheck = "";


  })
  templateListBtn.addEventListener('click', function (evt) {

    templateCheck += "List"
    console.log(templateCheck)
    insertTemplateSlide();
    templateCheck = "";

  })

  let listItemIndex = 1;

  function addListItem() {
    //const paragraphDom = document.getElementById("presParagraph");

    /*
    let presentation = localStorage.getItem("PresentationProject");
    presentation = JSON.parse(presentation);
    let value = "1456723";
    let key = "list";
    presentation.slides["Slide" + currentSlide][key] = value;
    localStorage.setItem("PresentationProject", JSON.stringify(presentation));
    //presentation.slides["Slide" + currentSlide][key] = value;
    updatePresLocal(key, value, currentSlide);*/
    //updatePresLocal("list", "1234", currentSlide);
  
    //paragraphDom.innerHTML += `<p id='listItem${listItemIndex}'>&#8226; edit</p>`;
    //listItemIndex++;
    /*var node = document.createElement("LI");
    var textnode = document.createTextNode("Click to write");
    node.appendChild(textnode);
    document.getElementById("templateSlideList").appendChild(node);*/
  }

  async function insertTemplateSlide() {
    let templateNr = 1;

    /*
    if (templateCheck === "Title") {

      html = `
          <div id="theme"> </div>
          <h1 id="presTitle" class="w3-center"> My Title</h1>
          
        `;

      document.getElementById("edit").innerHTML = html;
      
    }*/
    if (templateCheck === "Picture") {
      templateNr = 2;
      /*
            html = `<h1 id="presTitle" class="w3-center"> My Title</h1>
            <label id="btnFile" for="inpFile">Select file
              <img id="btnImg" >
              </label>   
           <input id="inpFile" type="file" accept="image/*" />
           <button id="btnSend">Send data</button>   `;
            document.getElementById("edit").innerHTML = html;
      
            let btnImg = document.getElementById('btnImg');
            let inpFile = document.getElementById('inpFile');
            let btnSend = document.getElementById('btnSend');
      
            btnSend.addEventListener('click', async function (evt) {
      
              console.log(imgdata)
              updatePresLocal("image", imgdata, currentSlide)
      
            });
            //select and handle image -------------------------
            inpFile.addEventListener('change', function (evt) {
      
              let file = inpFile.files[0];
      
              if (file.type != "image/png" && file.type != "image/jpeg") {
                console.log("wrong filetype");
                
              }
      
              if (file.size > 1000000) {
                console.log("the file is too large");
                
              }
      
              let freader = new FileReader();
              freader.addEventListener('load', function (evt) {
                btnImg.src = freader.result;
                imgdata = freader.result;
              });
              freader.readAsDataURL(file);
            });*/

    }
    if (templateCheck === "List") {
      templateNr = 3;

      /*

      html = `
          <div id="theme"> </div>
          <h1 id="presTitle" class="w3-center"></h1>
          <div id="presParagraph">
           <ul id="templateSlideList">
           </ul>
          </div>`;
      document.getElementById("edit").innerHTML = html;

      */


    }



    //test

    let presentation = localStorage.getItem("PresentationProject");
    presentation = JSON.parse(presentation);

    if (presentation === null) {
      location.href = "/userIndex.html";
      return;
    }

    const token = sessionStorage.getItem("token");
    const username = sessionStorage.getItem("user");
    const body = { authToken: token, user: username, presentation: presentation, slide: currentSlide, template: templateNr };

    let url = `/presentations/update/${presentation.id}/slides/${currentSlide}/${templateNr}`;
    let resp = await callServerAPI(body, url);
    let statusCode = resp.response.status;

    if (statusCode === 200) {
      getPresentation();
    }

    //




  }




  // enkel sjekk om det finnes token i sessionstorage, hvis ikke så sendes brukeren til login

  checkIfUserHasToken();
  function checkIfUserHasToken() {
    const token = sessionStorage.getItem("token");
    if (!token) {
      location.href = "/";
    }
  }

  //


  const editListener = document.getElementById("edit");

  editListener.addEventListener("click", function (evt) {
    let target = evt.target.id;
    console.log(target)

    if (target !== "edit") {
      editText(target, currentSlide);
    }
  });

  function editText(text, slide) {
    if (!text || !slide) {
      return;
    }

    let editText = document.getElementById(text);
    editText.innerHTML = `<input id='edit${text}'></input>`;

    let editNewText = document.getElementById(`edit${text}`);
    editNewText.addEventListener("keypress", function (evt) {

      let saveKey = 13;
      let cancelKey = 27;


      let keyCode = evt.keyCode;

      if (keyCode === saveKey) {

        let key = "";
        switch (text) {
          case "presTitle":
            key = "title";
            break;

          default:
            return;
        }

        updatePresLocal(key, editNewText.value, slide);

      }



    })
  }

  function checkKey() {

  }

  const presentationVisability = document.getElementById("presentationVisability");

  function changeVisability(status, change) {

    let html = "";

    if (status === "private") {

      html = `<a href="#" class="w3-bar-item w3-button" onClick="changeVisability('public', true)">
                  <div id="private" name="visability" value="private">
                    <i class="fa fa-lock"></i></div>
                  <label>Private</label>
            </a>`;

      if (change) {
        updatePresLocal("ispublic", false);
      }

    } else {

      html = `<a href="#" class="w3-bar-item w3-button" onClick="changeVisability('private', true)">
                  <div id="public" name="visability" value="public">
                    <i class="fa fa-unlock"></i></div>
                  <label>Public</label>
            </a>`;

      if (change) {
        updatePresLocal("ispublic", true);
      }

    }

    presentationVisability.innerHTML = html;

  }

  // dropdown function w3.css

  goBackBtn = document.getElementById("goBackBtn");

  function myAccount() {
    var x = document.getElementById("Acc");
    if (x.className.indexOf("w3-show") == -1) {
      x.className += " w3-show";
    } else {
      x.className = x.className.replace(" w3-show", "");
    }
  }

  const logOut = document.getElementById("logOut");

  logOut.addEventListener("click", function (evt) {
    localStorage.clear();
    sessionStorage.clear();
    location.href = "/";
  });

  const accountText = document.getElementById("accountText");
  const username = sessionStorage.getItem("user");
  if (username) {
    accountText.innerHTML = username;
  }

  const slideListener = document.getElementById("allSlides");;

  getPresentation(); //laster inn PresentationProject hvis dette finnes
  async function getPresentation() {
    let presentation = localStorage.getItem("PresentationProject");
    presentation = JSON.parse(presentation);

    if (presentation === null) {
      location.href = "/userIndex.html";
      return;
    }

    const token = sessionStorage.getItem("token");
    const username = sessionStorage.getItem("user");
    const body = { authToken: token, user: username, presentationId: presentation.id };
    const url = `/user/presentation/${presentation.id}`;

    const results = await callServerAPI(body, url);

    const pres = results.data[0];
    const slides = pres.slides;

    if (slides) {

      let bildeUrl = "pictures/Theme_Light.png";

      if (pres.theme === "Dark") {
        //const themeStyle = document.getElementById("theme");
        //themeStyle.innerHTML = `<img id="themeImage" src="pictures/Theme_Dark.png">`;
        bildeUrl = "pictures/Theme_Dark.png";
      }

      let edit = document.getElementById("edit");
      edit.style.background = "url(" + bildeUrl + ")";
      edit.style.width = "100%";
      edit.style.height = "550px";

      localStorage.setItem("PresentationProject", JSON.stringify(pres));

      gotoSlide(currentSlide);

      refreshPresentation();

    } else {
      location.href = "/userIndex.html";
    }
  }

  function refreshPresentation() {

    let presentation = localStorage.getItem("PresentationProject");
    presentation = JSON.parse(presentation)
    slides = presentation.slides;

    const resetInp = document.getElementById("renamePres");
    resetInp.innerHTML = `<input id="renamePresInp" type="text" placeholder="Rename presentation">`;

    if (presentation.ispublic === false) {

      changeVisability("private", false);
    } else {
      changeVisability("public", false);
    }

    const thisPres = document.getElementById("thisPres");
    thisPres.innerHTML = "You are working on: " + presentation.name;

    const allSlides = document.getElementById("allSlides");

    allSlides.innerHTML = "";

    const totalSlides = Object.entries(slides).length;

    if (presentation.slides.Slide1 !== undefined) {
      allSlides.innerHTML += `<li id="Slides" class="w3-hover-grey w3-button tablinkSlide slideTab" value="1">Slide 1 </li>`
    }

    for (let i = 2; i <= totalSlides; i++) {
      allSlides.innerHTML += `<br><li id="Slides" class="w3-hover-grey w3-button tablinkSlide slideTab" value="${i}">Slide ${i}</li>`;
    }

    //slideListener = document.getElementById("allSlides");

  }



  slideListener.addEventListener("click", function (evt) {

    if (evt.target.id === "Slides") {
      gotoSlide(evt.target.value);
    }

  });


  let currentSlide = 1;

  function gotoSlide(slideNr) {
    let presentation = localStorage.getItem("PresentationProject");
    presentation = JSON.parse(presentation);

    if (slideNr === undefined) {
      if (presentation.slides.Slide1 !== undefined) {
        slideNr = 1;
      } else {
        return;
      }
    }

    currentSlide = slideNr;



    let titleDom = document.getElementById("presTitle");
    let paragraphDom = document.getElementById("presParagraph");

    paragraphDom.innerHTML = "";
    titleDom.innerHTML = "";
    addListBtn.className = "w3-hide";

    let slideEditMode = presentation.slides["Slide" + currentSlide];
    if (!slideEditMode) {

      currentSlide--;
      slideEditMode = presentation.slides["Slide" + currentSlide];

      if (!slideEditMode) {
        return;
      }
    }


    titleDom.innerHTML = slideEditMode.title;

    if (slideEditMode.image) {
      paragraphDom.innerHTML = slideEditMode.image;
      paragraphDom.innerHTML += slideEditMode.imageText;
    }

    if (slideEditMode.list) {

      let listArr = slideEditMode.list;

      listArr = listArr.split(" ");

      for (let i = 0; i < listArr.length; i++) {
        paragraphDom.innerHTML += `<p id='listItem${listItemIndex}'>&#8226; ${listArr[i]}</p>`
        listItemIndex++;
      }

      addListBtn.className = "w3-show";
    }







    //

  }

  const newSlideBtn = document.getElementById("newSlideBtn");

  newSlideBtn.addEventListener("click", async function (evt) {
    await updatePresentation();

    let presentation = localStorage.getItem("PresentationProject");
    presentation = JSON.parse(presentation);
    currentSlide = Object.entries(presentation.slides);

    currentSlide = currentSlide.length + 1;

    const token = sessionStorage.getItem("token");
    const username = sessionStorage.getItem("user");
    const body = { authToken: token, user: username, presentationId: presentation.id };
    const url = `/user/presentation/${presentation.id}/slide`;

    const results = await callServerAPI(body, url);

    if (results.response.status === 200) {
      getPresentation();
    }
  });


  const deleteSlideBtn = document.getElementById("deleteSlideBtn");

  deleteSlideBtn.addEventListener("click", async function (evt) {

    let presentation = localStorage.getItem("PresentationProject");
    presentation = JSON.parse(presentation);

    const token = sessionStorage.getItem("token");
    const username = sessionStorage.getItem("user");
    const body = { authToken: token, user: username, presentation: presentation, slide: currentSlide };
    const url = `/presentations/delete/${presentation.id}/slides/${currentSlide}`;

    const results = await callServerAPI(body, url);

    if (results.response.status === 200) {
      getPresentation();
    }
  });

  goBackBtn.addEventListener("click", function (evt) {
    location.href = "/userIndex.html";
  });

  function updatePresLocal(key, value, slide) {
    if (key === "" || value === "") {
      return;
    }

    let presentation = localStorage.getItem("PresentationProject");
    presentation = JSON.parse(presentation);

    if (slide) {
      presentation.slides["Slide" + slide][key] = value;
    } else {
      presentation[key] = value;
    }

    localStorage.setItem("PresentationProject", JSON.stringify(presentation));
  }

  async function updatePresentation() {

    const text = document.getElementById("renamePresInp").value
    if (text !== "") {
      updatePresLocal("name", text);
    }

    let presentation = localStorage.getItem("PresentationProject");
    presentation = JSON.parse(presentation);


    const token = sessionStorage.getItem("token");
    const username = sessionStorage.getItem("user");
    const body = { authToken: token, user: username, presentation: presentation };
    const url = `/presentations/update/${presentation.id}`;

    const results = await callServerAPI(body, url);

    if (results.response.status === 200) {
      refreshPresentation();
    }
  }





  // fetch server api function

  async function callServerAPI(body, url) {

    if (body === "" || url === "" || !body.authToken) {
      return;
    }

    const config = {
      method: "POST",
      headers: {
        "content-type": "application/json"
      },
      body: JSON.stringify(body)
    }

    const response = await fetch(url, config);
    const data = await response.json();
    console.log(response.status);
    return { "response": response, "data": data };
  };

//


</script>